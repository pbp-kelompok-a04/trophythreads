{% extends 'base.html' %}
{% load static %}
{% block content %}
{% include 'header.html' %}
<div class="container mx-auto p-6">
  <h2 class="text-2xl font-bold mb-4">Your Cart</h2>
  <div id="cart-container">
    {% if cart.items.count == 0 %}
      <div class="text-center">
        <img src="{% static 'image/no-merch.png' %}" alt="no merch" class="mx-auto w-64">
        <p class="mt-4">Your cart is empty</p>
      </div>
    {% else %}
      <table class="w-full">
        <thead>...</thead>
        <tbody>
          {% for item in cart.items.all %}
          <tr data-item-id="{{ item.id }}">
            <td><input type="checkbox" class="select-item" data-item-id="{{ item.id }}" {% if item.selected %}checked{% endif %}></td>
            <td><img src="{{ item.product.thumbnail }}" class="w-20 h-20 object-cover"></td>
            <td>{{ item.product.name }}</td>
            <td>{{ item.variant }}</td>
            <td>Rp {{ item.product.price }}</td>
            <td>
              <button class="qty-dec" data-id="{{ item.id }}">-</button>
              <span class="qty" id="qty-{{ item.id }}">{{ item.quantity }}</span>
              <button class="qty-inc" data-id="{{ item.id }}">+</button>
            </td>
            <td><button class="delete-item" data-id="{{ item.id }}">Delete</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-6">
        <a href="{% url 'cartApp:checkout' %}" id="checkout-btn" class="btn">Checkout</a>
      </div>
    {% endif %}
  </div>
</div>
{% include 'footer.html' %}

<script>
/* Basic event handlers using fetch + CSRF cookie (use getCookie helper from main templates) */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
          }
      }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.addEventListener('click', async (e) => {
  if (e.target.matches('.qty-inc')) {
    const id = e.target.dataset.id;
    await fetch('{% url "cartApp:update_cart_item" 0 %}'.replace('0', id), {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken},
      body: new URLSearchParams({action: 'inc'})
    }).then(r => r.json()).then(console.log);
    location.reload();
  }
  if (e.target.matches('.qty-dec')) {
    const id = e.target.dataset.id;
    await fetch('{% url "cartApp:update_cart_item" 0 %}'.replace('0', id), {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken},
      body: new URLSearchParams({action: 'dec'})
    }).then(r => r.json()).then(data => {
      if (data.confirm_delete) {
        if (confirm('Quantity will be removed. Delete item?')) {
          fetch('{% url "cartApp:delete_item" 0 %}'.replace('0', id), {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken}
          }).then(()=>location.reload());
        }
      } else location.reload();
    });
  }
  if (e.target.matches('.delete-item')) {
    const id = e.target.dataset.id;
    if (!confirm('Are you sure delete?')) return;
    await fetch('{% url "cartApp:delete_item" 0 %}'.replace('0', id), {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken}
    });
    location.reload();
  }
  if (e.target.matches('.select-item')) {
    const id = e.target.dataset.itemId;
    await fetch('{% url "cartApp:toggle_select" 0 %}'.replace('0', id), {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken}
    });
    location.reload();
  }
});
</script>
{% endblock content %}
