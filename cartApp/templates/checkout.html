{% extends 'base.html' %}
{% block content %}
{% include 'header.html' %}
<div class="container mx-auto p-6">
  <h2 class="text-2xl mb-4">Checkout</h2>

  <form id="checkout-form" method="POST" action="{% url 'cartApp:checkout' %}">
    {% csrf_token %}
    <div>
      <label>Nama</label>
      <input type="text" value="{{ request.user.username if request.user.is_authenticated else request.session.guest_name }}" disabled>
    </div>
    <div>
      <label>Address (required)</label>
      <input name="address" required>
    </div>

    <h3>Items</h3>
    <ul>
      {% for item in items %}
        <li>{{ item.product.name }} ({{ item.variant }}) x{{ item.quantity }} - Rp {{ item.line_total }}</li>
      {% endfor %}
    </ul>

    <div>
      <label>Notes (optional)</label>
      <textarea name="notes"></textarea>
    </div>

    <div>
      <h4>Payment method</h4>
      <label><input type="radio" name="payment_method" value="gopay" checked> Gopay</label>
      <label><input type="radio" name="payment_method" value="bca_oneclick"> BCA OneClick</label>
      <label><input type="radio" name="payment_method" value="bri_oneclick"> BRI OneClick</label>
    </div>

    <div>
      <p>Subtotal: Rp {{ total_before_fee }}</p>
      <p>Shipping: Rp {{ shipping_fee }}</p>
      <p>Service: Rp {{ service_fee }}</p>
      <p>Total: Rp {{ total_before_fee|add:shipping_fee|add:service_fee }}</p>
    </div>

    <button type="submit" id="place-order">Place Order</button>
    <a href="{% url 'cartApp:cart_page' %}">Return to cart</a>
  </form>
</div>

<script>
const form = document.getElementById('checkout-form');
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = new FormData(form);
  data.append('is_ajax', 'true');
  const res = await fetch(form.action, {method:'POST', body: data, headers: {'X-CSRFToken': getCookie('csrftoken')}});
  const json = await res.json();
  if (json.redirect_url) window.location.href = json.redirect_url;
  else alert(json.error || 'Unknown error');
});
</script>
{% include 'footer.html' %}
{% endblock content %}
