{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Checkout - TrophyThreads</title>
{% endblock meta %}

{% block content %}
<div class="min-h-screen bg-[#FFF1F1] pb-32">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 pt-6">

    <!-- Header -->
    <div class="rounded-lg bg-white p-4 mb-6 shadow-sm flex items-center gap-3">
      <a href="{% url 'cartApp:cart_page' %}" class="flex items-center gap-2 text-[#000]">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 18L9 12L15 6"></path>
        </svg>
        <span class="text-lg font-semibold">Checkout</span>
      </a>
    </div>

    <!-- Info User -->
    <div class="bg-white p-5 rounded-lg border border-[#EEEDED] shadow-sm mb-5">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-[#ED3F27]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 21C12 21 4 13.941 4 9.5C4 6.462 6.462 4 9.5 4C12.538 4 15 6.462 15 9.5C15 13.941 7 21 7 21"/>
        </svg>
        <div class="flex-1">
          <p class="text-[#ED3F27] font-semibold text-lg">{{ user.username }}</p>
          <label class="text-sm text-gray-600 font-medium mt-2 block">Adress</label>
          <textarea id="address" rows="2" required class="w-full border border-gray-300 rounded-md mt-1 p-2 text-sm focus:ring-[#ED3F27] focus:border-[#ED3F27]" placeholder="Masukkan alamat lengkap">{{ user.profile.address|default_if_none:"" }}</textarea>
        </div>
      </div>
    </div>

    <!-- Produk -->
     {% for item in items %}
    <div class="cart-item flex flex-col sm:flex-row gap-4 p-4 border rounded-lg bg-white shadow-sm">
      <!-- ===== TOP ROW: gambar + detail produk (sejajar) ===== -->
      <div class="flex items-start gap-4 w-full">
        <div class="w-24 h-24 flex-shrink-0 overflow-hidden rounded-md bg-gray-100">
          <img src="{{ item.product.thumbnail|default:item.product_thumbnail }}" 
              alt="{{ item.product.name|default:item.product_name }}" 
              class="object-cover w-full h-full" />
        </div>

        <div class="flex-1">
          <h3 class="text-lg font-semibold text-gray-800">
            {{ item.product.name|default:item.product_name }}
          </h3>

          {% if item.variant %}
          <div class="text-sm text-gray-600 mt-1">{{ item.variant }}</div>
          {% endif %}

          <p class="text-sm text-gray-600 mt-2">
            Rp {{ item.product.price|default:item.product_price }}
          </p>

          <!-- kalau mau info lain (stock, qty) taro sini -->
          <div class="mt-3 text-sm text-gray-500">
            Stock: <span>{{ item.product.stock|default:item.product_stock }}</span>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}

    <!-- Total Produk -->
    <div class="bg-white p-4 rounded-lg border border-[#EEEDED] shadow-sm flex justify-between text-sm font-medium mb-5">
      <span>Total {{ items.count }} Produk</span>
      <span>Rp {{ total_before_fee }}</span>
    </div>

    <!-- Metode Pembayaran -->
    <div class="bg-white p-5 rounded-lg border border-[#EEEDED] shadow-sm mb-5">
      <p class="font-semibold mb-3">Metode Pembayaran</p>

      <!-- pilihan utama -->
      <div class="flex gap-4 mb-3">
        <!-- E-Wallet -->
        <div>
          <input id="main-ewallet" type="radio" name="main_payment" value="ewallet" class="sr-only" />
          <label for="main-ewallet"
            class="inline-block px-6 py-2 rounded-xl text-lg font-medium border border-gray-200 shadow-sm hover:bg-gray-100 transition
                  hover:opacity-200 peer-checked:bg-[#F3F3F3]">
            Ewallet
          </label>
        </div>

        <!-- BCA OneKlik -->
        <div>
          <input id="main-bca" type="radio" name="main_payment" value="bca_oneklik" class="sr-only" />
          <label for="main-bca"
            class="inline-block px-6 py-2 rounded-xl text-lg font-medium border border-gray-200 shadow-sm hover:bg-gray-100 transition
                  hover:opacity-200">
            BCA Oneklik
          </label>
        </div>

        <!-- BRI OneKlik -->
        <div>
          <input id="main-bri" type="radio" name="main_payment" value="bri_oneklik" class="sr-only" />
          <label for="main-bri"
            class="inline-block px-6 py-2 rounded-xl text-lg font-medium border border-gray-200 shadow-sm hover:bg-gray-100 transition
                  hover:opacity-200">
            BRI Oneklik
          </label>
        </div>
      </div>

      <!-- sub-options E-Wallet -->
      <div id="ewallet-options" class="hidden ml-0 mt-2 flex flex-col gap-2">
        <label class="flex items-center gap-2">
          <input type="radio" name="payment_method" value="gopay" class="text-[#ED3F27] focus:ring-[#ED3F27]">
          <span>Gopay</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="payment_method" value="ovo" class="text-[#ED3F27] focus:ring-[#ED3F27]">
          <span>OVO</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="payment_method" value="flip" class="text-[#ED3F27] focus:ring-[#ED3F27]">
          <span>Flip</span>
        </label>
      </div>
    </div>

    <!-- Rincian Pembayaran -->
    <div class="bg-white p-5 rounded-lg border border-[#EEEDED] shadow-sm mb-20">
      <p class="font-semibold mb-3">Rincian Pembayaran</p>
      <div class="text-sm text-gray-700 space-y-1">
        <div class="flex justify-between">
          <span>Subtotal Pesanan</span><span>Rp {{ total_before_fee }}</span>
        </div>
        <div class="flex justify-between">
          <span>Subtotal Pengiriman</span><span>Rp {{ shipping_fee }}</span>
        </div>
        <div class="flex justify-between">
          <span>Biaya Layanan</span><span>Rp {{ service_fee }}</span>
        </div>
      </div>
      <div class="border-t border-gray-300 mt-3 pt-3 flex justify-between font-semibold text-[#ED3F27] text-lg">
        <span>Total Pembayaran</span>
        <span id="grand-total">Rp {{ total_before_fee|add:shipping_fee|add:service_fee }}</span>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="fixed bottom-0 left-0 right-0 bg-[#ED3F27] text-white shadow-lg">
    <div class="max-w-3xl mx-auto flex justify-between items-center px-6 py-4">
      <div>
        <p class="font-semibold">
          Total Rp {{ total_before_fee|add:shipping_fee|add:service_fee }}
        </p>
        <p class="text-xs opacity-90">Hemat Rp 0</p>
      </div>
      <button id="checkout-btn" class="bg-white text-[#ED3F27] font-semibold px-6 py-3 rounded-md hover:opacity-95 transition">
        Buat Pesanan
      </button>
    </div>
  </div>
</div>

<!-- Toast -->
<script>
function showToast(msg, type='info') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-5 py-3 rounded-lg text-white font-medium shadow-lg z-50 transition-opacity duration-500 ${
    type==='success'?'bg-green-500':type==='error'?'bg-[#ED3F27]':'bg-gray-800'
  }`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  setTimeout(()=>toast.style.opacity='0',2000);
  setTimeout(()=>toast.remove(),2500);
}

// Show e-wallet sub options
document.querySelectorAll('input[name="main_payment"]').forEach(radio => {
  radio.addEventListener('change', () => {
    const ewalletOptions = document.getElementById('ewallet-options');
    ewalletOptions.classList.toggle('hidden', radio.value !== 'ewallet');
    // reset semua label
    document.querySelectorAll('label[for^="main-"]').forEach(lbl => 
      lbl.classList.remove('bg-gray-200')
    );

    const activeLabel = document.querySelector(`label[for="${radio.id}"]`);
    if (activeLabel) activeLabel.classList.add('bg-gray-200');
  });
});


document.getElementById('checkout-btn').addEventListener('click', async () => {
  const address = document.getElementById('address').value.trim();
  if (!address) {
    showToast('Alamat wajib diisi', 'error');
    return;
  }

  const paymentSub = document.querySelector('input[name="payment_method"]:checked')?.value;
  const paymentMain = document.querySelector('input[name="main_payment"]:checked')?.value;
  const selected = paymentSub || paymentMain;
  if (!selected) {
    showToast('Pilih metode pembayaran terlebih dahulu', 'error');
    return;
  }

  const res = await fetch("{% url 'cartApp:checkout' %}", {
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded'},
    body: new URLSearchParams({ address, payment_method: selected })
  });
  const data = await res.json().catch(()=>({}));
  if (res.ok && data.message) {
    showToast('Pesanan berhasil dibuat!', 'success');
    setTimeout(()=>window.location.href=data.redirect_url,1200);
  } else {
    showToast(data.error || 'Gagal membuat pesanan', 'error');
  }
});
</script>

{% endblock content %}
