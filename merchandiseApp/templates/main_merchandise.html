{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Merchandise</title>
{% endblock meta %}

{% block content %}
{% include 'header.html' %}
{% include 'footer.html' %}

<div class="min-h-screen" style="background-color: var(--color-background);">
    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-6">
        
        <!-- spacer to avoid fixed header overlapping content -->
        <div class="h-14 sm:h-14" aria-hidden="true"></div>

        <!-- Upper Section -->
        <div class="mx-auto max-w-auto mb-8">
            <div style="background: linear-gradient(135deg, #ffd4ce 30%, #d998a0 61%); border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); padding: 1.5rem; text-align: center;">
                <h1 style="font-family: 'Roboto Serif'; font-weight: bold; font-size: 2.25rem; margin-bottom: 20px;">
                    Support Your Nation, Wear Your Passion !
                </h1>
                <p style="font-family: 'Montserrat'; font-size: 1rem;">
                    Merchandise resmi Timnas Indonesia, dimana setiap purchase<br>
                    mendukung perkembangan sepak bola tanah air.
                </p>
            </div>
        </div>

        <!-- Middle Section -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
            <div style="margin-bottom: 10px;">
                <h2 style="font-family: var(--font-title); font-weight: bold; font-size: 1.25rem; margin-bottom: 7px;">Latest Products</h2>
                <p style="font-family: var(--font-title); font-size: 0.9rem;">Stay updated with the newest Timnas's Merchandise</p>
            </div>
            <div class="flex space-x-3 mb-4 sm:mb-0">
                <button onclick="showCreateModal()" style="font-family: var(--font-title); color: white; font-size: small; font-weight: 700; background: linear-gradient(135deg, #ED3F27 35%, #863030 70%); border-radius: 0.5rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); text-align: center; padding-left: 30px; padding-right: 30px; padding-top: 12px; padding-bottom: 12px;">
                    + Create Merchandise Product
                </button>
            </div>
        </div>

        <!-- Merchandise Container -->
        <div id="merchandise-container" class="space-y-4">
            <!-- Loading State -->
            <div id="loadingState" class="bg-white rounded-xl border border-gray-200 p-8 sm:p-12 text-center shadow-lg">
                <div class="w-20 h-20 sm:w-32 sm:h-32 mx-auto mb-4 sm:mb-6">
                <div class="animate-spin rounded-full h-full w-full border-b-2 border-red-400 mx-auto"></div>
                </div>
                <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-2 sm:mb-3">Loading Merchandises</h3>
                <p class="text-gray-500 text-sm sm:text-base">We're gathering the latest Timnas's Merchandise for you...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden bg-white rounded-xl border border-gray-200 p-8 sm:p-12 text-center shadow-lg">
                <div class="w-20 h-20 sm:w-32 sm:h-32 mx-auto mb-4 sm:mb-6">
                <i class="fas fa-exclamation-triangle text-red-400 text-3xl sm:text-6xl"></i>
                </div>
                <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-2 sm:mb-3">Failed to Load Merchandises</h3>
                <p class="text-gray-500 mb-4 sm:mb-6 text-sm sm:text-base" id="errorMessage">There was an error loading the merchandises.</p>
                <button onclick="loadMerchandises()" class="inline-flex items-center px-4 py-2 sm:px-6 sm:py-3 bg-orange-400 text-white rounded-lg hover:bg-orange-500 transition-all duration-200 shadow-lg text-sm sm:text-base">
                <i class="fas fa-redo mr-2"></i>
                Try Again
                </button>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden bg-white rounded-xl border border-gray-200 p-8 sm:p-12 text-center shadow-lg">
                <div class="w-32 h-32 sm:w-48 sm:h-48 mx-auto mb-4 sm:mb-6">
                <div class="w-full h-full bg-gradient-to-br from-red-50 to-red-100 rounded-full flex items-center justify-center">
                    <i class="fa-solid fa-futbol text-red-400 text-6xl sm:text-6xl" aria-hidden="true"></i>
                </div>
                </div>
                <h3 class="text-lg sm:text-xl font-semibold text-gray-900 mb-2 sm:mb-3">No Merchandise Found</h3>
                <p class="text-gray-500 mb-4 sm:mb-6 text-sm sm:text-base">Please wait until Timnas's Merchandise is available.</p>
            </div>

            <!-- Merchandise Grid -->
            <div id="merchandise" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6">
                <!-- Merchandise cards will be loaded here by JavaScript -->
            </div>
        </div>

    </div>
</div>

<script>  
  window.currentUserId = "{{ user.id|default:'' }}";
// Function untuk scroll ke atas
function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
}

function showLoadingState() {
    console.log('Showing loading state');
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('errorState').classList.add('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('merchandise').classList.add('hidden');
}

function showErrorState(message) {
    console.log('Showing error state:', message);
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorState').classList.remove('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('merchandise').classList.add('hidden');
    if (message) {
        document.getElementById('errorMessage').textContent = message;
    }
}

function showEmptyState() {
    console.log('Showing empty state');
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorState').classList.add('hidden');
    document.getElementById('emptyState').classList.remove('hidden');
    document.getElementById('merchandise').classList.add('hidden');
}

function showMerchandiseGrid() {
    console.log('Showing merchandise grid');
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('errorState').classList.add('hidden');
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('merchandise').classList.remove('hidden');
}

function loadMerchandises() {
    console.log('Loading merchandises...');
    showLoadingState();

    const urlParams = new URLSearchParams(window.location.search);

    let url = 'get-merchandise/';

    console.log('Fetching from URL:', url);

    fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            if (!response.ok) {
                throw new Error('Network response was not ok: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('Raw API response:', data);
            console.log('Response type:', typeof data);
            console.log('Is array?', Array.isArray(data));
            
            if (data && typeof data === 'object') {
                console.log('Response keys:', Object.keys(data));
            }

            renderMerchandises(data);
        })
        .catch(error => {
            console.error('Error loading merchandises:', error);
            showErrorState('Failed to load merchandises. Please check your connection and try again.');
        });
}

function renderMerchandises(merchandises) {
    console.log('Rendering merchandises:', merchandises);
    const merchandiseGrid = document.getElementById('merchandise');

    if (!merchandiseGrid) {
        console.error('Merchandise grid element not found!');
        showErrorState('Merchandise grid container not found');
        return;
    }

    merchandiseGrid.innerHTML = '';

    // Handle different response formats
    let merchandisesArray = [];

    if (Array.isArray(merchandises)) {
        merchandisesArray = merchandises;
    } else if (merchandises && typeof merchandises === 'object') {
        // Handle object response (might be {merchandises: [], count: X})
        if (Array.isArray(merchandises.merchandises)) {
            merchandisesArray = merchandises.merchandises;
        } else if (Array.isArray(merchandises.data)) {
            merchandisesArray = merchandises.data;
        } else if (Array.isArray(merchandises.items)) {
            merchandisesArray = merchandises.items;
        } else {
            // Convert object to array if it's {1: {...}, 2: {...}}
            merchandisesArray = Object.values(merchandises);
        }
    }

    console.log('Processed merchandises array:', merchandisesArray);

    if (!merchandisesArray || merchandisesArray.length === 0) {
        console.log('No merchandise found, showing empty state');
        showEmptyState();
        return;
    }

    console.log(`Rendering ${merchandisesArray.length} merchandises`);

    merchandisesArray.forEach(merchandise => {
        try {
            const merchandiseCard = createMerchandiseCard(merchandise);
            merchandiseGrid.appendChild(merchandiseCard);
        } catch (error) {
            console.error('Error creating merchandise card:', error, merchandise);
        }
    });

    showMerchandiseGrid();
}

function createMerchandiseCard(merchandiseData) {
    console.log('Creating merchandise card for:', merchandiseData);

    let merchandise, merchandiseId;

    if (merchandiseData.fields && merchandiseData.pk) {
        merchandise = merchandiseData.fields;
        merchandiseId = merchandiseData.pk;
    } else if (merchandiseData.id) {
        merchandise = merchandiseData;
        merchandiseId = merchandiseData.id;
    } else {
        merchandise = merchandiseData;
        merchandiseId = merchandiseData.pk || merchandiseData.id || Math.random();
    }

    let merchandiseUserId;
    if (merchandise.user) {
        if (typeof merchandise.user === 'object') {
            merchandiseUserId = merchandise.user.id || merchandise.user.pk || merchandise.user.toString();
        } else {
            merchandiseUserId = merchandise.user.toString();
        }
    } else {
        merchandiseUserId = null;
    }

    // Get user info from Django template
    const currentUserId = window.currentUserId;
    const isOwner = currentUserId && currentUserId !== 'None' && currentUserId.toString() === merchandiseUserId.toString();

    console.log('Merchandise details:', { merchandiseId, merchandise, currentUserId, isOwner });

    const card = document.createElement('article');
    card.className = 'bg-white rounded-xl border border-gray-200 hover:shadow-xl transition-all duration-300 overflow-hidden merchandise-card';
    card.id = `merchandise-${merchandiseId}`;

    card.innerHTML = `
        <div class="aspect-[4/3] relative overflow-hidden bg-gray-100">
            ${merchandise.thumbnail ? 
                `<img src="${merchandise.thumbnail}" alt="${merchandise.name}" 
                      class="w-full h-full object-cover transition-transform duration-300 hover:scale-105"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">` :
                ''
            }
            <div class="w-full h-full ${merchandise.thumbnail ? 'hidden' : 'flex'} items-center justify-center text-gray-400 bg-gradient-to-br from-gray-50 to-gray-100">
                <i class="fas fa-shopping-bag text-4xl opacity-50"></i>
            </div>
            
            <!-- Category Badge -->
            <div class="absolute top-3 left-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-pink-400 text-white shadow-lg">
                    ${getCategoryDisplay(merchandise.category)}
                </span>
            </div>
            
            <!-- Status Badges -->
            <div class="absolute top-3 right-3 flex flex-col space-y-1">
                ${merchandise.is_featured ? 
                    '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800 shadow-sm"><i class="fas fa-star mr-1"></i> Featured</span>' : ''
                }
                ${merchandise.product_views > 30 ? 
                    '<span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800 shadow-sm"><i class="fas fa-fire mr-1"></i> Hot</span>' : ''
                }
            </div>
        </div>
        
        <div class="p-6">
            <!-- Merchandise Name -->
            <h3 class="text-xl font-bold text-gray-900 mb-3 line-clamp-2 leading-tight hover:text-pink-500 transition-colors">
                <a href="/merchandise/${merchandiseId}/" class="hover:no-underline">
                    ${merchandise.name}
                </a>
            </h3>
            
            <!-- Price -->
            <div class="mb-4">
                <span class="text-2xl font-bold text-pink-500">
                    Rp${parseInt(merchandise.price).toLocaleString('id-ID')}
                </span>
            </div>
            
            <!-- Rating and Stock -->
            <div class="flex items-center mb-4">
                <div class="flex items-center text-yellow-400 mr-2">
                    ${generateStarRating(merchandise.review.rating || 0)}
                </div>
                <span class="text-yellow-700 font-semibold text-sm">${merchandise.rating || '0.0'}</span>
                <span class="mx-2">•</span>
                <span class="text-gray-400 text-sm ml-1">${merchandise.stock || 0} in stock</span>
            </div>         
            
            <!-- Description Preview -->
            ${merchandise.description ? `
                <p class="text-gray-600 text-sm mb-4 line-clamp-2">
                    ${merchandise.description.substring(0, 100)}${merchandise.description.length > 100 ? '...' : ''}
                </p>
            ` : ''}
            
            <!-- Action Buttons -->
            <div class="flex items-center justify-between pt-4 border-t border-gray-100">
                <a href="/merchandise/${merchandiseId}/" 
                   class="inline-flex items-center text-pink-500 hover:text-pink-600 font-medium text-sm transition-colors group">
                    Read more
                    <i class="fas fa-arrow-right ml-1 transform group-hover:translate-x-1 transition-transform"></i>
                </a>
                
                ${isOwner ? `
                    <div class="flex space-x-2">
                        <button onclick="event.stopPropagation(); showEditModal('${merchandiseId}')" 
                                class="text-blue-400 hover:text-blue-500 text-xs transition-colors px-2 py-1 rounded hover:bg-blue-50">
                            Edit
                        </button>
                        <button onclick="event.stopPropagation(); showDeleteModal('${merchandiseId}')" 
                                class="text-red-400 hover:text-red-500 text-xs transition-colors px-2 py-1 rounded hover:bg-red-50">
                            Delete
                        </button>
                    </div>
                ` : ''}
            </div>
        </div>
    `;

    return card;
}

function showEditModal(merchandiseId) {
    // Set modal title and button
    document.getElementById('modalTitle').textContent = 'Edit Merchandise';
    document.getElementById('submitButtonText').textContent = 'Update Merchandise';
    document.getElementById('merchandiseId').value = merchandiseId;

    // Fetch merchandise data 
    fetch(`/json/${merchandiseId}/`)
        .then(response => response.json())
        .then(data => {
            // If using Django's serializer, data is an array
            const merchandise = data[0].fields;
            document.getElementById('name').value = merchandise.name || '';
            document.getElementById('price').value = merchandise.price || '';
            document.getElementById('category').value = merchandise.category || '';
            document.getElementById('rating').value = merchandise.rating || '';
            document.getElementById('stock').value = merchandise.stock || '';
            document.getElementById('thumbnail').value = merchandise.thumbnail || '';
            document.getElementById('description').value = merchandise.description || '';
            document.getElementById('is_featured').checked = merchandise.is_featured ? true : false;
        })
        .catch(() => {
            showToast('Failed to load merchandise data', 'error');
        });

    // Show modal
    const modal = document.getElementById('merchandiseModal');
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.add('modal-enter');
    }, 10);
}

function generateStarRating(rating) {
    const fullStars = Math.floor(rating);
    const halfStar = rating % 1 >= 0.5;
    const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
    
    let stars = '';
    
    // Full stars
    for (let i = 0; i < fullStars; i++) {
        stars += '<i class="fas fa-star"></i>';
    }
    
    // Half star
    if (halfStar) {
        stars += '<i class="fas fa-star-half-alt"></i>';
    }
    
    // Empty stars
    for (let i = 0; i < emptyStars; i++) {
        stars += '<i class="far fa-star"></i>';
    }
    
    return stars;
}

function getCategoryDisplay(category) {
    const categories = {
        'jersey': '<i class="fas fa-tshirt mr-1"></i> Jersey',
        'socks': '<i class="fas fa-socks mr-1"></i> Socks',
        'ball': '<i class="fas fa-basketball-ball mr-1"></i> Ball',
        'accessory': '<i class="fas fa-vest mr-1"></i> Accessory'
    };
    return categories[category] || `<i class="fas fa-tag mr-1"></i> ${category}`;
}

// Form submission
function setupFormHandler() {
    const form = document.getElementById('merchandiseForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            const formData = new FormData(this);
            const merchandiseId = document.getElementById('merchandiseId').value;

            const url = merchandiseId ? `/edit-ajax/${merchandiseId}/` : '/create-ajax/';
            console.log('Sending to URL:', url);

            const isFeaturedCheckbox = document.getElementById('is_featured');
            if (isFeaturedCheckbox.checked) {
                formData.set('is_featured', 'true');
            } else {
                formData.set('is_featured', 'false');
            }

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.message) {
                    hideModal();
                    showToast(merchandiseId ? 'Merchandise updated successfully!' : 'Merchandise created successfully!', 'success');
                    loadMerchandises();
                } else {
                    showToast('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
            });
        });
    }
}

// Delete merchandise function
function deleteMerchandise(merchandiseId) {
    console.log('Attempting to delete merchandise:', merchandiseId);

    if (!merchandiseId) {
        showToast('Merchandise ID is missing', 'error');
        return;
    }

    fetch(`/delete-ajax/${merchandiseId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => {
        console.log('Delete response status:', response.status);
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Delete response data:', data);
        if (data.message) {
            hideDeleteModal();
            // Remove merchandise from DOM
            const merchandiseElement = document.getElementById(`merchandise-${merchandiseId}`);
            if (merchandiseElement) {
                merchandiseElement.remove();
                showToast('Merchandise deleted successfully!', 'success');
            }
            loadMerchandises();
        } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred. Please try again.', 'error');
    });
}

function initializeMerchandiseManager() {
    console.log('Initializing merchandise manager...');

    const refreshButton = document.getElementById('refreshButton');
    if (refreshButton) {
        refreshButton.addEventListener('click', function() {
            loadMerchandises();
            showToast('Merchandise refreshed!', 'success');
        });
    }
    
    setupFormHandler();
    loadMerchandises();
}

// Make functions globally available
window.loadMerchandises = loadMerchandises;
window.renderMerchandises = renderMerchandises;
window.createMerchandiseCard = createMerchandiseCard;
window.showEditModal = showEditModal;
window.deleteMerchandise = deleteMerchandise;
window.initializeMerchandiseManager = initializeMerchandiseManager;

// Mobile-specific functionality
document.addEventListener('DOMContentLoaded', function() {
  // Add touch feedback for mobile buttons
  const buttons = document.querySelectorAll('button, a');
  buttons.forEach(button => {
    button.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.95)';
    });
    
    button.addEventListener('touchend', function() {
      this.style.transform = 'scale(1)';
    });
  });
  
  // Show/hide scroll to top button based on scroll position
  let scrollToTopBtn;
  window.addEventListener('scroll', function() {
    if (!scrollToTopBtn) {
      scrollToTopBtn = document.querySelector('[onclick="scrollToTop()"]');
    }
    
    if (scrollToTopBtn) {
      if (window.pageYOffset > 300) {
        scrollToTopBtn.style.opacity = '1';
        scrollToTopBtn.style.visibility = 'visible';
      } else {
        scrollToTopBtn.style.opacity = '0';
        scrollToTopBtn.style.visibility = 'hidden';
      }
    }
  });
});

// Simple Modal Functions untuk Edit dan Delete
function showEditModal(merchandiseId) {
    console.log('Edit merchandise:', merchandiseId);
    document.getElementById('modalTitle').textContent = 'Edit Merchandise';
    document.getElementById('submitButtonText').textContent = 'Update Merchandise';
    document.getElementById('merchandiseId').value = merchandiseId;

    // Fetch merchandise data 
    fetch(`/json/${merchandiseId}/`)
        .then(response => response.json())
        .then(data => {
            const merchandise = data[0].fields;
            document.getElementById('name').value = merchandise.name;
            document.getElementById('price').value = merchandise.price;
            document.getElementById('category').value = merchandise.category;
            document.getElementById('rating').value = merchandise.rating;
            document.getElementById('stock').value = merchandise.stock;
            document.getElementById('thumbnail').value = merchandise.thumbnail || '';
            document.getElementById('description').value = merchandise.description || '';
            document.getElementById('is_featured').checked = merchandise.is_featured;
        });

    // Show modal
    const modal = document.getElementById('merchandiseModal');
    modal.classList.remove('hidden');
    setTimeout(() => {
        modal.classList.add('modal-enter');
    }, 10);
}

function showDeleteModal(merchandiseId) {
    console.log('Delete merchandise:', merchandiseId);

    if (confirm('Are you sure you want to delete this merchandise?')) {
        deleteMerchandise(merchandiseId);
    }
}

// Simple delete function
function deleteMerchandise(merchandiseId) {
    console.log('Deleting merchandise:', merchandiseId);

    fetch(`/delete-merchandise/${merchandiseId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/x-www-form-urlencoded',
        },
    })
    .then(response => {
        if (response.ok) {
            showToast('Merchandise deleted successfully!', 'success');
            // Refresh merchandise
            loadMerchandises();
        } else {
            showToast('Failed to delete merchandise', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while deleting merchandise', 'error');
    });
}

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white ${
        type === 'success' ? 'bg-blue-400' : 
        type === 'error' ? 'bg-red-500' : 
        'bg-pink-500'
    } z-50`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Create modal function (jika belum ada)
function showCreateModal() {
    window.location.href = '/create-merchandise/';
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load merchandise
    loadMerchandises();

    // Initialize scroll to top button state
    const scrollToTopBtn = document.querySelector('[onclick="scrollToTop()"]');
    if (scrollToTopBtn) {
        scrollToTopBtn.style.opacity = '0';
        scrollToTopBtn.style.visibility = 'hidden';
        scrollToTopBtn.style.transition = 'all 0.3s ease';
    }
});
</script>

{% endblock content %}