{% extends "base.html" %}
{% load tz %}

{% block title %}Ratings & Reviews{% endblock %}

{% block content %}
{% include "header.html" %}
<style>
  :root{
    --font-title:'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    --font-body:'Open Sans', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    --maroon:#7a0e22;
    --accent:#ED3F27;
    --bg:#FFF1F1;
    --text:#222;
    --muted:#6b6b6b;
    --line:#ead6da;
    --radius:10px;
    --shadow:0 6px 18px rgba(0,0,0,.06);
  }

  /* background halaman */
  html, body {
    margin:0;
    background: var(--bg) !important;
    color: var(--text);
    font-family: var(--font-body);
  }

  /* warna khusus untuk header dari header.html */
  nav.fixed {
    background-color: #7a0e22 !important; /* maroon */
  }

  nav.fixed a,
  nav.fixed span {
    color: #ffffff !important; /* teks header putih */
  }

  .page {
    width: 100%;
    max-width: none;
    margin: 0 auto 56px;
    padding-top: 64px;
  }

  .panel {width: 100%;background:#ffffff;border-radius:var(--radius);box-shadow:var(--shadow);}
  .panel.header {padding:18px 24px;margin-bottom:18px;--radius:0px;}
  .header-bar {display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;}
  .header-title {font-family:var(--font-title);font-size:22px;font-weight:800;color:var(--maroon);margin:0;white-space:nowrap;}
  .header-center {display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:center;flex:1;}
  .btn-primary {background:var(--accent);color:#fff;text-decoration:none;padding:10px 20px;border-radius:10px;font-weight:800;border:0;box-shadow:inset 0 -2px 0 rgba(0,0,0,.18);line-height:1;white-space:nowrap;transition:all .2s ease;}
  .btn-primary:hover {background:#c42b1c;}
  .pill {display:inline-flex;align-items:center;gap:8px;padding:8px 16px;border-radius:12px;text-decoration:none;background:#7a0e22;color:#fff;font-weight:700;box-shadow:0 1px 2px rgba(0,0,0,.06);transition:all .2s ease;}
  .pill .star {color:#ED3F27;font-size:14px;}
  .pill .count {font-weight:300;font-size:13px;margin-left:4px;opacity:.9;}
  .pill.active {background:#ED3F27;}
  .pill.active .star {color:#fff;}
  .panel.list {padding:14px;}
  .review-card {background:#fff;border:1px solid #efdddd;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:14px 16px;margin:10px 0;}
  .r-head {display:grid;grid-template-columns:42px 1fr;gap:10px;align-items:center;}
  .avatar {width:42px;height:42px;border-radius:50%;background:#f4d9dc;color:var(--maroon);display:grid;place-items:center;font-weight:800;font-family:var(--font-title);}
  .name {font-weight:800;}
  .date {color:var(--muted);font-size:12px;margin-top:2px;}
  .stars {color:#ffb400;font-size:18px;margin:6px 0 8px;}
  .body {line-height:1.55;}
  .actions {display:flex;gap:8px;justify-content:flex-end;margin-top:8px;}
  .btn-outline {background:#fff;border:1px solid #d9898d;color:#a2333b;padding:6px 12px;border-radius:10px;text-decoration:none;font-weight:700;}
  #toast-container {position:fixed;top:20px;right:20px;display:flex;flex-direction:column;gap:10px;z-index:9999;}
  .toast {background:#fff;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,0.15);padding:12px 16px;font-weight:600;animation:slideIn .3s ease;border-left:6px solid var(--accent);color:#7a0e22;display:flex;align-items:center;gap:10px;min-width:320px;}
  .toast.success::before {content:"✅";}
  .toast.warning::before {content:"⚠️";}
  .toast.error::before {content:"❌";}
  .toast.info::before {content:"ℹ️";}
  .toast.success {border-color:#2e7d32;}
  .toast.warning {border-color:#ff9800;}
  .toast.error {border-color:#d32f2f;}
  .toast.info {border-color:#1976d2;}
  @keyframes slideIn {from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
</style>

<div class="page">

  {% if messages %}
  <div id="toast-container">
    {% for message in messages %}
      <div class="toast {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <section class="panel header">
    <div class="header-bar">
      <h2 class="header-title">Ratings and Reviews</h2>

      <div class="header-center">
        <a class="pill {% if stars == 'all' %}active{% endif %}" href="?stars=all">
          <span class="label">All</span><span class="count">{{ total|default:0 }}</span>
        </a>
        <a class="pill {% if stars == '5' %}active{% endif %}" href="?stars=5">
          <span class="star">★</span><span class="label">5</span><span class="count">{{ counts.5|default:0 }}</span>
        </a>
        <a class="pill {% if stars == '4' %}active{% endif %}" href="?stars=4">
          <span class="star">★</span><span class="label">4</span><span class="count">{{ counts.4|default:0 }}</span>
        </a>
        <a class="pill {% if stars == '3' %}active{% endif %}" href="?stars=3">
          <span class="star">★</span><span class="label">3</span><span class="count">{{ counts.3|default:0 }}</span>
        </a>
        <a class="pill {% if stars == '2' %}active{% endif %}" href="?stars=2">
          <span class="star">★</span><span class="label">2</span><span class="count">{{ counts.2|default:0 }}</span>
        </a>
        <a class="pill {% if stars == '1' %}active{% endif %}" href="?stars=1">
          <span class="star">★</span><span class="label">1</span><span class="count">{{ counts.1|default:0 }}</span>
        </a>
      </div>

      {% if can_review %}
        <a href="{% url 'reviewproduct:add_review' product.id %}" class="btn-primary">Add Review</a>
      {% endif %}
    </div>
  </section>

  <section class="panel list">
    {% for r in reviews %}
      {% include "card_review.html" with review=r product=product %}
    {% empty %}
      <div class="review-card">Belum ada review.</div>
    {% endfor %}
    
  </section>
</div>


<script>
document.addEventListener("DOMContentLoaded", function() {
  const toasts = document.querySelectorAll(".toast");
  toasts.forEach((toast, i) => {
    toast.style.opacity = "0";
    toast.style.transform = "translateY(-10px)";
    toast.style.transition = "all 0.3s ease";
    setTimeout(() => {
      toast.style.opacity = "1";
      toast.style.transform = "translateY(0)";
    }, 200 + i * 150);
  });
  setTimeout(() => {
    toasts.forEach(toast => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(-10px)";
      setTimeout(() => toast.remove(), 400);
    });
  }, 3500);

  const addReviewBtn = document.querySelector(".btn-primary");
  if (addReviewBtn) {
    addReviewBtn.addEventListener("click", function (event) {
      event.preventDefault();
      const url = this.getAttribute("href");
      const rating = prompt("Masukkan rating (1-5):");
      const comment = prompt("Tulis komentar kamu:");
      if (!rating || !comment) {
        showToast("error", "Rating dan komentar wajib diisi!");
        return;
      }
      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({ rating, comment }),
      })
      .then(res => res.json())
      .then(data => {
        if (data.error) showToast("error", data.error);
        else {
          showToast("success", data.message || "Review berhasil ditambahkan!");
          setTimeout(() => location.reload(), 1200);
        }
      })
      .catch(() => showToast("error", "Terjadi kesalahan. Coba lagi."));
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showToast(type, text) {
    const container = document.getElementById("toast-container") || createToastContainer();
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.textContent = text;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }

  function createToastContainer() {
    const div = document.createElement("div");
    div.id = "toast-container";
    div.style.position = "fixed";
    div.style.top = "20px";
    div.style.right = "20px";
    div.style.zIndex = "9999";
    document.body.appendChild(div);
    return div;
  }
});
</script>
{% endblock %}
