{% extends "base.html" %}
{% load tz %}

{% block title %}Ratings & Reviews{% endblock %}

{% block content %}
{% include "header.html" %}

<style>
  :root {
    --font-title: 'Poppins', 'Montserrat', sans-serif;
    --font-body: 'Open Sans', system-ui, sans-serif;
    --maroon: #7a0e22;
    --accent: #ED3F27;
    --bg: #fff8f8;
    --text: #2b2b2b;
    --muted: #757575;
    --radius: 0px;
    --shadow: 0 0px 24px rgba(0,0,0,0.08);
  }

  html, body {
    margin: 0;
    background: var(--bg) !important;
    color: var(--text);
    font-family: var(--font-body);
  }

  nav.fixed {
    background-color: var(--maroon) !important;
  }
  nav.fixed a, nav.fixed span {
    color: #ffffff !important;
  }

  .page {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 64px 20px 40px;
    animation: fadeIn 0.4s ease-in-out;
    min-height: calc(100vh - 200px);
  }

  /* Header panel */
  .panel {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    transition: all .25s ease;
  }

  .panel.header {
    padding: 20px 28px;
    margin-bottom: 24px;
  }

  .header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 18px;
  }

  .header-title {
    font-family: var(--font-title);
    font-size: 26px;
    font-weight: 800;
    color: var(--maroon);
    margin: 0;
    letter-spacing: 0.3px;
  }

  .header-center {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    flex: 1;
  }

  /* Filter pill buttons */
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 700;
    font-size: 14px;
    background: #f7dede;
    color: var(--maroon);
    border: 1px solid #f1caca;
    transition: all .2s ease;
  }
  .pill .star { color: #ffb400; }
  .pill.active {
    background: linear-gradient(135deg, var(--accent), var(--maroon));
    color: #fff;
    border: none;
  }
  .pill.active .star { color: #fff; }
  .pill:hover {
    transform: translateY(-2px);
    background: #ffe0e0;
  }
  .pill.active:hover {
    background: linear-gradient(135deg, var(--accent), var(--maroon));
  }

  /* Add Review Button */
  .btn-add-anim {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(90deg, #ff5f3d, #7a0e22);
    color: #fff;
    padding: 10px 22px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 15px;
    text-decoration: none;
    box-shadow: 0 6px 14px rgba(237,63,39,0.25);
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .btn-add-anim:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 20px rgba(237,63,39,0.35);
  }
  .btn-add-anim::after {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.25);
    transform: skewX(-20deg);
    transition: left 0.5s ease;
  }
  .btn-add-anim:hover::after {
    left: 120%;
  }

  /* Review list panel */
  .panel.list {
    padding: 18px;
  }

  .review-card {
    background: #fff;
    border: 1px solid #f2dcdc;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    padding: 18px 20px;
    margin: 12px 0;
    transition: transform 0.25s ease, box-shadow 0.25s ease, opacity 0.3s ease;
  }

  .review-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  }

  .r-head {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
  }

  .avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #f5c6c6;
    color: var(--maroon);
    display: grid;
    place-items: center;
    font-weight: 800;
    font-size: 16px;
  }

  .name {
    font-weight: 700;
    font-size: 15px;
    color: var(--text);
  }

  .date {
    font-size: 13px;
    color: var(--muted);
    margin-top: 2px;
  }

  .stars {
    color: #ffb400;
    font-size: 18px;
    margin: 8px 0;
  }

  .stars .on {
    color: #ffb400;
  }

  .stars .off {
    color: #ddd;
  }

  .body {
    color: var(--text);
    line-height: 1.6;
    margin-top: 8px;
  }

  .review-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 12px;
  }

  .btn-delete, .btn-edit {
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
    transition: all .2s ease;
    text-decoration: none;
  }

  .btn-delete {
    background: linear-gradient(135deg, var(--accent), #b81414);
    color: white;
    border: none;
  }
  .btn-delete:hover {
    opacity: .9;
    transform: translateY(-1px);
  }
  .btn-delete:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-edit {
    background: #fff;
    border: 1px solid var(--maroon);
    color: var(--maroon);
    display: inline-block;
  }
  .btn-edit:hover {
    background: var(--maroon);
    color: #fff;
  }

  /* Back to Home Button */
  .btn-back-anim {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(90deg, #ff5f3d, #7a0e22);
    color: #fff;
    padding: 12px 28px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    text-decoration: none;
    box-shadow: 0 6px 14px rgba(237,63,39,0.25);
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .btn-back-anim:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(237,63,39,0.35);
  }
  .btn-back-anim::after {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: rgba(255,255,255,0.2);
    transform: skewX(-20deg);
    transition: left 0.5s ease;
  }
  .btn-back-anim:hover::after {
    left: 120%;
  }

  /* Toast notification */
  #toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 9999;
  }

  .toast {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    padding: 12px 16px;
    font-weight: 600;
    border-left: 6px solid var(--accent);
    color: var(--maroon);
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 320px;
    opacity: 0;
    transform: translateY(-6px);
    transition: all .3s ease;
  }
  .toast.success { border-left-color: #2e7d32; }
  .toast.error { border-left-color: #d32f2f; }
  .toast.success::before { content: "‚úÖ"; }
  .toast.error::before { content: "‚ùå"; }

  /* Subtle fade animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    color: var(--muted);
    font-weight: 600;
    padding: 40px 20px;
    line-height: 1.8;
  }

  
  .back-home-container {
    text-align: center;
    margin-top: 50px;
    margin-bottom: 60px;
  }

  .btn-simple-back {
  display: inline-block;
  font-weight: 600;
  color: #b5371b;
  text-decoration: none;
  font-size: 16px;
  margin-top: 10px;   /* jarak dari atas */
  margin-bottom: 10px; 
  transition: color 0.2s ease;
}

  .btn-simple-back:hover {
    color: #7a0e22;
    text-decoration: underline;
  }


</style>

<div class="page">
  <!-- Toast Messages -->
  {% if messages %}
  <div id="toast-container">
    {% for message in messages %}
      <div class="toast {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <a href="{% url 'merchandiseApp:show_merchandise' product.id %}" class="btn-simple-back">‚Üê Back</a>



  <!-- Header Section -->
  <section class="panel header">
    <div class="header-bar">
      <h2 class="header-title">üí¨ Ratings and Reviews</h2>
      
      <div class="header-center">
        <a class="pill {% if stars == 'all' %}active{% endif %}" href="?stars=all">
          All <span class="count">{{ total|default:0 }}</span>
        </a>
        {% for i in "54321" %}
          <a class="pill {% if stars == i %}active{% endif %}" href="?stars={{ i }}">
            <span class="star">‚òÖ</span> {{ i }}
            <span class="count">
              {% if i == '5' %}{{ counts.5|default:0 }}
              {% elif i == '4' %}{{ counts.4|default:0 }}
              {% elif i == '3' %}{{ counts.3|default:0 }}
              {% elif i == '2' %}{{ counts.2|default:0 }}
              {% elif i == '1' %}{{ counts.1|default:0 }}
              {% endif %}
            </span>
          </a>
        {% endfor %}
      </div>

      {% if can_review %}
        <a href="{% url 'reviewproduct:add_review' product.id %}" class="btn-add-anim">
          Ôºã Add Review
        </a>
      {% endif %}
    </div>
  </section>
  
  
  <!-- Reviews List Section -->
  <section class="panel list">
    {% for r in reviews %}
      {% include "card_review.html" with review=r product=product %}
    {% empty %}
      <div class="review-card empty-state">
        Belum ada review üòî<br>
        Jadilah yang pertama memberikan ulasan!
      </div>
    {% endfor %}
  </section>

  <!-- Back to Home Button -->
  <div class="back-home-container">
    <a href="{% url 'merchandiseApp:show_main' %}" class="btn-back-anim">
      üè† Kembali ke Home
    </a>
  </div>
</div>

{% include 'footer.html' %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("üü¢ Review page loaded");

  // ==================== TOAST ANIMATION ====================
  const toasts = document.querySelectorAll(".toast");
  toasts.forEach((toast, i) => {
    setTimeout(() => {
      toast.style.opacity = "1";
      toast.style.transform = "translateY(0)";
    }, 200 + i * 150);
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.remove(), 300);
    }, 3500 + i * 100);
  });

  // ==================== DELETE REVIEW ====================
  const deleteButtons = document.querySelectorAll(".btn-delete");
  console.log(`üîç Found ${deleteButtons.length} delete button(s)`);

  deleteButtons.forEach((btn, index) => {
    console.log(`Button ${index + 1}: ${btn.dataset.url}`);
    
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      
      const url = this.dataset.url;
      const card = this.closest(".review-card");
      
      console.log("üóëÔ∏è Delete clicked:", url);
      
      if (!confirm("Yakin ingin menghapus review ini?")) {
        console.log("‚ùå User cancelled");
        return;
      }

      // Disable button
      this.disabled = true;
      const originalText = this.textContent;
      this.textContent = "Menghapus...";
      console.log("‚è≥ Sending delete request...");

      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/json",
        },
      })
      .then(res => {
        console.log("üì° Response status:", res.status);
        console.log("üì° Response ok:", res.ok);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const contentType = res.headers.get("content-type") || "";
        if (!contentType.includes("application/json")) {
          console.warn("‚ö†Ô∏è Non-JSON response, reloading...");
          location.reload();
          return null;
        }
        
        return res.json();
      })
      .then(data => {
        if (!data) return;
        
        console.log("‚úÖ Response data:", data);
        
        if (data.success || data.message) {
          showToast("success", data.message || "Review berhasil dihapus!");
          
         
          card.style.transition = "all 0.4s ease";
          card.style.opacity = "0";
          card.style.transform = "translateX(30px) scale(0.95)";
          
          setTimeout(() => {
            card.remove();
            console.log("üóëÔ∏è Card removed from DOM");
            
            const remainingReviews = document.querySelectorAll(".review-card:not(.empty-state)").length;
            console.log(`üìä Remaining reviews: ${remainingReviews}`);
            
            if (remainingReviews === 0) {
              console.log("üîÑ No reviews left, reloading...");
              setTimeout(() => location.reload(), 500);
            }
          }, 400);
        } else {
          throw new Error(data.error || "Gagal menghapus review");
        }
      })
      .catch(err => {
        console.error("‚ùå Error:", err);
        showToast("error", err.message || "Terjadi kesalahan server");
        
        // Re-enable button
        this.disabled = false;
        this.textContent = originalText;
      });
    });
  });

  // ==================== HELPER FUNCTIONS ====================
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showToast(type, text) {
    const container = document.getElementById("toast-container") || createToastContainer();
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.textContent = text;
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = "1";
      toast.style.transform = "translateY(0)";
    }, 50);
    
    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(-10px)";
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function createToastContainer() {
    const div = document.createElement("div");
    div.id = "toast-container";
    div.style.position = "fixed";
    div.style.top = "20px";
    div.style.right = "20px";
    div.style.zIndex = "9999";
    document.body.appendChild(div);
    return div;
  }
});
</script>

{% endblock content %}