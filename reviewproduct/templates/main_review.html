{% extends "base.html" %}
{% load tz %}

{% block title %}Ratings & Reviews{% endblock %}

{% block content %}
{% include "header.html" %}

<style>
  :root {
    --font-title: 'Poppins', 'Montserrat', sans-serif;
    --font-body: 'Open Sans', system-ui, sans-serif;
    --maroon: #7a0e22;
    --accent: #ED3F27;
    --bg: #fff8f8;
    --text: #2b2b2b;
    --muted: #757575;
    --radius: 0px;
    --shadow: 0 0px 24px rgba(0,0,0,0.08);
  }

  html, body {
    margin: 0;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
  }

  nav.fixed {
    background-color: var(--maroon) !important;
  }
  nav.fixed a, nav.fixed span {
    color: #ffffff !important;
  }

  .page {
    width: 100%;
    margin: 0 auto 80px;
    padding-top: 64px;
    animation: fadeIn 0.4s ease-in-out;
  }

  /* Header panel */
  .panel {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    transition: all .25s ease;
  }

  .panel.header {
    padding: 20px 28px;
    margin-bottom: 24px;
  }

  .header-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 18px;
  }

  .header-title {
    font-family: var(--font-title);
    font-size: 26px;
    font-weight: 800;
    color: var(--maroon);
    margin: 0;
    letter-spacing: 0.3px;
  }

  .header-center {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
    flex: 1;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--maroon));
    color: #fff;
    text-decoration: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-weight: 700;
    border: none;
    box-shadow: 0 4px 12px rgba(237,63,39,0.25);
    transition: all .2s ease;
  }
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(237,63,39,0.3);
    opacity: .95;
  }

  /* Filter pill buttons */
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 700;
    font-size: 14px;
    background: #f7dede;
    color: var(--maroon);
    border: 1px solid #f1caca;
    transition: all .2s ease;
  }
  .pill .star { color: #ffb400; }
  .pill.active {
    background: linear-gradient(135deg, var(--accent), var(--maroon));
    color: #fff;
    border: none;
  }
  .pill.active .star { color: #fff; }
  .pill:hover {
    transform: translateY(-2px);
    background: #ffe0e0;
  }

  /* Review list panel */
  .panel.list {
    padding: 18px;
  }

  .review-card {
    background: #fff;
    border: 1px solid #f2dcdc;
    border-radius: 16px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    padding: 18px 20px;
    margin: 12px 0;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
  }

  .review-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  }

  .avatar {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #f5c6c6;
    color: var(--maroon);
    display: grid;
    place-items: center;
    font-weight: 800;
  }

  .review-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 8px;
  }

  .btn-delete, .btn-edit {
    padding: 6px 12px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 13px;
    transition: all .2s ease;
  }

  .btn-delete {
    background: linear-gradient(135deg, var(--accent), #b81414);
    color: white;
    border: none;
  }
  .btn-delete:hover {
    opacity: .9;
    transform: translateY(-1px);
  }

  .btn-edit {
    background: #fff;
    border: 1px solid var(--maroon);
    color: var(--maroon);
  }
  .btn-edit:hover {
    background: var(--maroon);
    color: #fff;
  }

  /* Toast notification */
  #toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 9999;
  }

  .toast {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    padding: 12px 16px;
    font-weight: 600;
    border-left: 6px solid var(--accent);
    color: var(--maroon);
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 320px;
    opacity: 0;
    transform: translateY(-6px);
    transition: all .3s ease;
  }
  .toast.success::before { content: "‚úÖ"; }
  .toast.error::before { content: "‚ùå"; }

  /* Subtle fade animation */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>

<div class="page">

  {% if messages %}
  <div id="toast-container">
    {% for message in messages %}
      <div class="toast {{ message.tags }}">{{ message }}</div>
    {% endfor %}
  </div>
  {% endif %}

  <section class="panel header">
    <div class="header-bar">
      <h2 class="header-title">üí¨ Ratings and Reviews</h2>
      <div class="header-center">
        <a class="pill {% if stars == 'all' %}active{% endif %}" href="?stars=all">
          All <span class="count">{{ total|default:0 }}</span>
        </a>
        {% for i in "54321" %}
          <a class="pill {% if stars == i %}active{% endif %}" href="?stars={{ i }}">
            <span class="star">‚òÖ</span> {{ i }}
            <span class="count">
              {% if i == '5' %}{{ counts.5|default:0 }}
              {% elif i == '4' %}{{ counts.4|default:0 }}
              {% elif i == '3' %}{{ counts.3|default:0 }}
              {% elif i == '2' %}{{ counts.2|default:0 }}
              {% elif i == '1' %}{{ counts.1|default:0 }}
              {% endif %}
            </span>
          </a>
        {% endfor %}
      </div>

      {% if can_review %}
  <a href="{% url 'reviewproduct:add_review' product.id %}" class="btn-add-anim">
    Ôºã Add Review
  </a>
{% endif %}

<style>
.btn-add-anim {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #ff5f3d, #7a0e22);
  color: #fff;
  padding: 10px 22px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 15px;
  text-decoration: none;
  box-shadow: 0 6px 14px rgba(237,63,39,0.25);
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
}


.btn-add-anim:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(237,63,39,0.35);
}


.btn-add-anim::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.25);
  transform: skewX(-20deg);
  transition: left 0.5s ease;
}

.btn-add-anim:hover::after {
  left: 120%;
}


.btn-add-anim:hover span {
  animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.3); }
}
</style>

    </div>
  </section>

  <section class="panel list">
    {% for r in reviews %}
      {% include "card_review.html" with review=r product=product %}
    {% empty %}
      <div class="review-card" style="text-align:center;color:var(--muted);font-weight:600;padding:30px 0;">
        Belum ada review üòî <br>Jadilah yang pertama memberikan ulasan!
      </div>
    {% endfor %}
  </section>

  <div style="text-align:center; margin-top:40px;">
  <a href="{% url 'merchandiseApp:show_main' %}"
     class="btn-back-anim">
     üè† Kembali ke Home
  </a>
</div>

<style>
.btn-back-anim {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(90deg, #ff5f3d, #7a0e22);
  color: #fff;
  padding: 12px 28px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 700;
  text-decoration: none;
  box-shadow: 0 6px 14px rgba(237,63,39,0.25);
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
}

.btn-back-anim:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(237,63,39,0.35);
}


.btn-back-anim::after {
  content: "";
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: rgba(255,255,255,0.2);
  transform: skewX(-20deg);
  transition: left 0.5s ease;
}

.btn-back-anim:hover::after {
  left: 120%;
}


.btn-back-anim:hover::before {
  animation: wiggle 0.6s ease-in-out;
}

@keyframes wiggle {
  0%, 100% { transform: rotate(0deg); }
  25% { transform: rotate(-10deg); }
  50% { transform: rotate(8deg); }
  75% { transform: rotate(-6deg); }
}
</style>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const toasts = document.querySelectorAll(".toast");
  toasts.forEach((toast, i) => {
    setTimeout(() => {
      toast.style.opacity = "1";
      toast.style.transform = "translateY(0)";
    }, 200 + i * 150);
    setTimeout(() => toast.remove(), 3500 + i * 100);
  });

  const deleteButtons = document.querySelectorAll(".btn-delete");
  deleteButtons.forEach(btn => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const url = this.dataset.url;
      if (!confirm("Yakin ingin menghapus review ini?")) return;

      fetch(url, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
          "X-Requested-With": "XMLHttpRequest",
        },
      })
      .then(async (res) => {
        const ct = res.headers.get("content-type") || "";
        if (!ct.includes("application/json")) {
          window.location = url;
          throw new Error("Non-JSON response");
        }
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      })
      .then((data) => {
        if (data && data.message) {
          showToast("success", data.message);
          const card = this.closest(".review-card");
          card.style.transition = "opacity 0.3s ease";
          card.style.opacity = "0";
          setTimeout(() => {
            card.remove();
            location.reload();
          }, 300);
        } else {
          showToast("error", (data && data.error) || "Gagal menghapus review.");
        }
      })
      .catch(() => {
        showToast("error", "Mengalihkan ke konfirmasi hapus...");
      });
    });
  });

  const addReviewBtn = document.querySelector(".btn-primary");
  if (addReviewBtn) {
    addReviewBtn.addEventListener("click", function (event) {
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function showToast(type, text) {
    const container = document.getElementById("toast-container") || createToastContainer();
    const toast = document.createElement("div");
    toast.className = `toast ${type}`;
    toast.textContent = text;
    container.appendChild(toast);
    setTimeout(() => {
      toast.style.opacity = "1";
      toast.style.transform = "translateY(0)";
    }, 50);
    setTimeout(() => toast.remove(), 3000);
  }

  function createToastContainer() {
    const div = document.createElement("div");
    div.id = "toast-container";
    div.style.position = "fixed";
    div.style.top = "20px";
    div.style.right = "20px";
    div.style.zIndex = "9999";
    document.body.appendChild(div);
    return div;
  }
});
</script>
{% endblock content %}
